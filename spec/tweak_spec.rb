require 'tempfile'
require 'bio'
require 'bio-commandeer'
require 'spec_helper'

describe 'finishm tweak' do
  path_to_script = File.join(File.dirname(__FILE__),'..','bin','finishm roundup')

  it 'should scripting test ok two scaffolds, one with a gap' do
    Dir.mktmpdir do |tmpdir|
      command = "#{path_to_script} --quiet --fasta-gz #{TEST_DATA_DIR }/tweak/1_gap_then_unscaffolded/reads.fa.gz "+
        "--genomes #{TEST_DATA_DIR}/tweak/1_gap_then_unscaffolded/scaffolds.fa --output-directory #{tmpdir}"
      Bio::Commandeer.run(command)#.should == ''
      output_file = File.join(tmpdir,'scaffolds.fa.scaffolds.fasta')
      File.exist?(output_file).should == true
      File.open(output_file).read.should == <<EOF
>scaffold1 random_sequence_length_5000_chopped_1-600_then_N_then_chopped_700-2000:random_sequence_length_5000_chopped_3000-5000$
TTCCGGGTGTTATGGTGTCGCCGTGTTAACTAATAACTTTGTCCGTGTCAATTGATAACGTAAACTGCCTATCTCACGTACGATCCACTACGCGCACCCGAACTTCGGAGAATTAGCAAAGGAAAGTGTATCAAGCATTTGGTAAAACAGATGGTATTCCTCAATACTGGGCTGACGCGGAAATAGCGCGAACTTATTTATCGGTACGTTAGGTGTATCTACTAAGTAAGATTTCTGATAGTTATCAGGGCGTTCTAAATTTAGTCTCACAGACCCCTGCGTATGCAGCCGCACAGCCAATGCCGATCCTTTCTAAGATAACTCCCGCAGGAAACGTGTAGATCCAAGCTTGTTCCTCGGAGTAGCAAGCTAACTTCAAGCTTACTCAAAGCAGACAAGTTTTAATAGTGCACGCCGTAACGTTCCCCGCAACGAGTATGTGATCCGGATGCGATAAACAAGCTGAGTCACCGTGACGGGGTACTAAGTAATGACATATTGCGAGCATATGCTCCACAAGAAATGTCATACAATAGCACCAATGAGCAAGTTCATATCTGTTATTATTCAGTTACTAAAAATATACTAGTAACTCGACCTGTTAGGTTATCTGCAAATCACTAGCTACTGTATCTCATAAGATTGTCAATCGCGTCATGTCCGCAACCAGGTGCGAACGTCTTGTCCCGGTATCTTGGAATTGAAAGGGACTTGCCAGTCATTAGGACACTAAACCGGATAAACCAGAAAAAAGGAATGCGCGCCGCGGAGGTGCACGATGCCAGCGCAGACAATAACGCCGGACCTTCCAGGGTTCATGGTCAAGTTAAGCGTGCGGCTGCAGCGCAAAATCGTTATCCCACCTCTTATATGCAACACCGTCGACGAAGCGAAGGATTATGAGGGTAGCTCGATAGAATGAAAGCACGTCTTGGGCGGAGGTTCGTTATGATGAAGGCGGTCTGGAGGTACGAGCCGAAAGAGGAGCCGCGTGCGACTCCGACTCGCGTAGTTGAAATCAGGGGGTTTAAACTCTACTTGCCAATTCACCTGATGTGTAACCTGAGGCTATGAGTTGCCAGAGGTCCAATATTTGCTAGTCTGGCTGAGGTTAAGCTAGTAGTTCTAACTACAGGCGGCAGGCCAATTGTGAGCCAACGCACTAGATCACGTGCATACAACCACAACACATAAACTCGCTTTAAAGTGCGGGGTGCCCCCGGTCGAACTAAGCTCTCGTCCACGTTTTGGGGGAAAAGTCCTATGGATCCTGAGACAGCGCGCCTCCACGGAGCAAAAGTTGTTGACCAATAGTCTGACCATAACAACATGTGACTGGGTAGCCCCTGGTCATCCCCCCACATTGCCGATTTGTCAACAGTTGCACTGCCTGGAGGATCATGCGTCAGGATCAAGTCTATCGCCCACGACATATGAATTTCCACTGTCCGTGCGTCGAACCACGACAGTATGTGAGACGTGTCGAAGTCCCCCCCTTAGTGAAACGGCACTTTCTTAACCAAAGATTAAGCGGCGCCTTGGAATGGTTATCCTACGAGGAGTATGTCATACTCACTCTGTTTCTAGAACAAGTCCGTGAGAATTAGGCTGTCGGAGTAGTTTAGATAAGTGTATTTTATCTTCCGAGGCTATGGCTGGTGTGAACAATTCCCCAGACTTCCGAATTTGACTTCCTCAGTTCCGGGGCTCCCCATGACCAAACTAGATGGAATAACCTACATGACCAAACTGTCGCTTCCTGTATTGTGCTCTCAAGACTATATGAGTCGAATTCCAAGGCGCTATATCGCCTATTAAGGCAAGGCAGCCTCTAGCGCTATGCATTTCGTAACGGAATTAACGCCCACACCATCCTCAATTAACGTTAGGTACTCATATCCCCCTCATATTGGGGCCAATACCCCAAGGAGTTCGGACACGATCAACCAGCGGCGTCACCGCCCCCAGTGTGCAACGTTGTGGGGGAACACGAAATATATAGTGTAAAGTTGATCTCCATTGCCCCGCAGACGAATTCGTACGAGAACAATGAGTATGGATAGCTAGACACAAACGTTGCATAAAATTCTTTAACTTAAAGAAAAAACAATCTCAGGCTACAATCTTCGTTCACAACTAACTTACCGGTCCTCCCTCAAAACATCAGGTGGACGCTTCTTCAACTTCCTCCCCATATTATCGGGCGTATGTCTATCAAAGTGCTCCGCTAGCACTCGGGAAGGACTTATGATAACTACTGATGCCACTCGGAGTCGCGTTCACATCGTTCCCTCGGTTAAGAAGCAGAGGGCGTCATTAGCATTCAGCACGATCACCTATCCTAGTCTGATGGGACATAGGTGCTTCAAGCACTCGCACATATTAGATTTGCTGCCGCTTATAGCCAATAAATTGTCTATGATATAACGTTCATAGCCATGTGCGTTACCCTAATGTTGAAGGCGTGGTGTAAAGGCCATCCGACAACGCACTTTCTGGGTGTTTCGGCTTGCTGCAACTCCCATATTCATCCCTCGCGATGTGCCCTTAACGCTGTGTCCTATGAACCGGAAGAGCTCTTGCTTTCCCTGATTAGTTTCGAAGCAGTCGTCAGGACTACCACTCTGTATGGGGGCCTGGAGGAGCTTGGGTACAGGGTACTGTCGAGGGTAAAACTCGTAGGCAAAGGAGCAATTCGCGGACCATTCAGGGCATGCTTCTCCGGCTCCTTAGCGGAGATTAAGTAGACTAAATAGAGAGTAATGATGGGTTTCAATTTGGTTTGCCGATGTTTTGGTGTGTGCTAGCGACTTGCAATCTTCAGTTCACTAAACAGATCGGGTCGCGGACTATACTTTATCCGACGAACAGTTCTCCGCCGTATATACGGGGCGAAGCGTGGCTATCGTGAGCACCAGATACAGAGATAGCGATTGGGGACACATATAAATTCAAATACGTACGGGTAGCTCACAAATGTAGGTCCCCAGGGTGCGTCGTAACCACCAGCGCTAACCGCCCGGGAGTTAGAGAGTCCAGTGGTGTGTGATCAAAGACCCGTTTAGCCGATGCCTACCACACCCGAACGGCAAACAGCGGTGTTCAACTACCGTGGCCGCCGCGTGCTTCCAGTCTTATAGTCCCTGTACCTACGGAGTGATCTACATCGAATAGGTTGTGATTGAACCGCGGCTCTCGGCACCCTAAGGCCTCTTCATTAATACCTCAATTTGGCATGAGGAGCGCTTCGCCATTCTGCTTATACATGTACCGGCTTGGGTGAGGTTGGAGAAAAAGCGACCTGTGGCGCCACGTGATGTCCTCCTAAGAGGCAGAATCCCCTCGCTTGTGGTTTTGCCGTAATCCTGGTGTAAGGTTAGGTGTACAATATCGCTGGTACTCTGATCGCCGAGATCCAGTATCGGCCCTGTGCAAAATCACACCATATTGTATAGTCAGGCCGTACAGAAATGACACCATTCGAGAGAGCCTTTCCACAAGAAATATCGGTTCTACTGTCGAGATTCCCGCCGGACTCGATCTCACGCCCGGAGGTCGGGGAACGTTTCCTTTGTGATTAGCATATGGAGACTATTTATGACTGGCGATGCTGTGGAGTCACTTAGTGGAAAGACACCTAATCGTGAGGGTACTATCAACGTGGCTGAGCCAATACATTGGATGAGTGTCCCCCCTGTCCCCCTTTCTATGTTCGTCCCGGAGGTCCCGATGTGTTTGATAGCCGCGAGGGATGATCGATGAGTACTGCCGCTGTCTTTCTGCGAGGTGCCAGCTTCCAAAAATGTGTCGGAGTCGTATCTTTCTTACGAAGGTTAGAAGTCTGAGCGCTAGATTTCTTAAATTTGCCGAGATAAAGCGCCGTGACTTTAATATGAGGATGGGAGCAACTACCTTCGCGCTCAGCATCCGTACCTTCGTGCGTTACCACAACCCCGAAGGCGTACAGGTAACCGTTCGAATTGACTACCCAAGGGCCCGGAAGTTAAATAGTAGGTTAGTGCAATGTGCGACTACTGTGGGTGTAAGTATATAATCGCCGGGACGTACAACCCTGGCAGCTTGTAGTCCAATTTCGCACATGTCGGTATAATTCTCGCTTAATCAGCATCATGGAGATCCCTTCGAGGCCAAGGGCCTAGAGAAACTAACGCGTAAACTACGCACTCTAAGGTACAGGGGTGAATCCGTAGCGACTACATTATCGCTGAAACCTCGGATCGTCGCTTTTTTCCAATCCTCAGGCGGCGAAACTTCGTAAATTGTACCAACCTGTGGCCGTGGCTAGGGTCGGTAAGATAGCGGGGAAACATGGTAAGTTACGATCGGGATGTCTGTAAGAACCAACCACGGACGCGACCGAAACCCCTACGCCATTAAAATCGGTTCTAATCCAGATTTATTCTATAATGCGCCTGTTGATCGTCGGCGGAACGAGCACGGCTGATCGACGTAGTACTCGCTTAGGTGCCCTCGGCCGTCCCCAACTTGTTTTATAGTTGTCTAAATTCTCCGTCTAGGACGTGGCCATCCGAGAGTTTTTACAACGAGAATTAGGAAACTATCGTCGCCGATTCCTTACCCTTATTGGAATGATGGGGCCGGGCTATAGTATCAGGACAGACCTGTTGACAATTAATATCTACTAGGATTGAAGCGACAGAACTCGGGTTATGACTTAACTATGTCTTCTTTATAATGACGAGACCTCAATTTGGGCGTAATGTGAGGAGCATAAGGATGTTCGTCACAAAAACAGTATGTCCGTCACACATATTCCTTATGGGTGGGTAAGCGGCTAAAATGTCTCGATCACAAACAAAGAACTGGATATCGGGGTGTATTACGGGGGGTATGCAATGTAAGCGCTGAGTAATCGCAAGAGGCTTAAAATGACGAATCTAAGTTCATTGCCTACCCTTAACGAGTATGGCTAATCGGTAGCCCTTCGCTGATGACTAAAACCTAAGCGCCGCCACAGA
EOF
    end
  end

  it 'should scripting test ok with reverse order of scaffolds' do
    answer = Bio::FlatFile.open("#{TEST_DATA_DIR}/tweak/1_gap_then_unscaffolded/answer.fa").entries[0].to_biosequence.to_s
    Dir.mktmpdir do |tmpdir|
      #File.open('/tmp/in2','w') do |t|
      Tempfile.open('testing_scaffolds') do |t|
        t.puts '>seq1'
        t.puts answer[2000..-1]
        t.puts '>seq2'
        t.puts answer[0..1500]
        t.close
        command = "#{path_to_script} --quiet --fasta-gz #{TEST_DATA_DIR }/tweak/1_gap_then_unscaffolded/reads.fa.gz "+
          "--genomes #{t.path} --output-directory #{tmpdir}"
        Bio::Commandeer.run command
        output_file = File.join(tmpdir,File.basename(t.path)+'.scaffolds.fasta')
        File.exist?(output_file).should == true
        File.open(output_file).read.should == <<EOF
>scaffold1 seq1:seq2
TCTGTGGCGGCGCTTAGGTTTTAGTCATCAGCGAAGGGCTACCGATTAGCCATACTCGTTAAGGGTAGGCAATGAACTTAGATTCGTCATTTTAAGCCTCTTGCGATTACTCAGCGCTTACATTGCATACCCCCCGTAATACACCCCGATATCCAGTTCTTTGTTTGTGATCGAGACATTTTAGCCGCTTACCCACCCATAAGGAATATGTGTGACGGACATACTGTTTTTGTGACGAACATCCTTATGCTCCTCACATTACGCCCAAATTGAGGTCTCGTCATTATAAAGAAGACATAGTTAAGTCATAACCCGAGTTCTGTCGCTTCAATCCTAGTAGATATTAATTGTCAACAGGTCTGTCCTGATACTATAGCCCGGCCCCATCATTCCAATAAGGGTAAGGAATCGGCGACGATAGTTTCCTAATTCTCGTTGTAAAAACTCTCGGATGGCCACGTCCTAGACGGAGAATTTAGACAACTATAAAACAAGTTGGGGACGGCCGAGGGCACCTAAGCGAGTACTACGTCGATCAGCCGTGCTCGTTCCGCCGACGATCAACAGGCGCATTATAGAATAAATCTGGATTAGAACCGATTTTAATGGCGTAGGGGTTTCGGTCGCGTCCGTGGTTGGTTCTTACAGACATCCCGATCGTAACTTACCATGTTTCCCCGCTATCTTACCGACCCTAGCCACGGCCACAGGTTGGTACAATTTACGAAGTTTCGCCGCCTGAGGATTGGAAAAAAGCGACGATCCGAGGTTTCAGCGATAATGTAGTCGCTACGGATTCACCCCTGTACCTTAGAGTGCGTAGTTTACGCGTTAGTTTCTCTAGGCCCTTGGCCTCGAAGGGATCTCCATGATGCTGATTAAGCGAGAATTATACCGACATGTGCGAAATTGGACTACAAGCTGCCAGGGTTGTACGTCCCGGCGATTATATACTTACACCCACAGTAGTCGCACATTGCACTAACCTACTATTTAACTTCCGGGCCCTTGGGTAGTCAATTCGAACGGTTACCTGTACGCCTTCGGGGTTGTGGTAACGCACGAAGGTACGGATGCTGAGCGCGAAGGTAGTTGCTCCCATCCTCATATTAAAGTCACGGCGCTTTATCTCGGCAAATTTAAGAAATCTAGCGCTCAGACTTCTAACCTTCGTAAGAAAGATACGACTCCGACACATTTTTGGAAGCTGGCACCTCGCAGAAAGACAGCGGCAGTACTCATCGATCATCCCTCGCGGCTATCAAACACATCGGGACCTCCGGGACGAACATAGAAAGGGGGACAGGGGGGACACTCATCCAATGTATTGGCTCAGCCACGTTGATAGTACCCTCACGATTAGGTGTCTTTCCACTAAGTGACTCCACAGCATCGCCAGTCATAAATAGTCTCCATATGCTAATCACAAAGGAAACGTTCCCCGACCTCCGGGCGTGAGATCGAGTCCGGCGGGAATCTCGACAGTAGAACCGATATTTCTTGTGGAAAGGCTCTCTCGAATGGTGTCATTTCTGTACGGCCTGACTATACAATATGGTGTGATTTTGCACAGGGCCGATACTGGATCTCGGCGATCAGAGTACCAGCGATATTGTACACCTAACCTTACACCAGGATTACGGCAAAACCACAAGCGAGGGGATTCTGCCTCTTAGGAGGACATCACGTGGCGCCACAGGTCGCTTTTTCTCCAACCTCACCCAAGCCGGTACATGTATAAGCAGAATGGCGAAGCGCTCCTCATGCCAAATTGAGGTATTAATGAAGAGGCCTTAGGGTGCCGAGAGCCGCGGTTCAATCACAACCTATTCGATGTAGATCACTCCGTAGGTACAGGGACTATAAGACTGGAAGCACGCGGCGGCCACGGTAGTTGAACACCGCTGTTTGCCGTTCGGGTGTGGTAGGCATCGGCTAAACGGGTCTTTGATCACACACCACTGGACTCTCTAACTCCCGGGCGGTTAGCGCTGGTGGTTACGACGCACCCTGGGGACCTACATTTGTGAGCTACCCGTACGTATTTGAATTTATATGTGTCCCCAATCGCTATCTCTGTATCTGGTGCTCACGATAGCCACGCTTCGCCCCGTATATACGGCGGAGAACTGTTCGTCGGATAAAGTATAGTCCGCGACCCGATCTGTTTAGTGAACTGAAGATTGCAAGTCGCTAGCACACACCAAAACATCGGCAAACCAAATTGAAACCCATCATTACTCTCTATTTAGTCTACTTAATCTCCGCTAAGGAGCCGGAGAAGCATGCCCTGAATGGTCCGCGAATTGCTCCTTTGCCTACGAGTTTTACCCTCGACAGTACCCTGTACCCAAGCTCCTCCAGGCCCCCATACAGAGTGGTAGTCCTGACGACTGCTTCGAAACTAATCAGGGAAAGCAAGAGCTCTTCCGGTTCATAGGACACAGCGTTAAGGGCACATCGCGAGGGATGAATATGGGAGTTGCAGCAAGCCGAAACACCCAGAAAGTGCGTTGTCGGATGGCCTTTACACCACGCCTTCAACATTAGGGTAACGCACATGGCTATGAACGTTATATCATAGACAATTTATTGGCTATAAGCGGCAGCAAATCTAATATGTGCGAGTGCTTGAAGCACCTATGTCCCATCAGACTAGGATAGGTGATCGTGCTGAATGCTAATGACGCCCTCTGCTTCTTAACCGAGGGAACGATGTGAACGCGACTCCGAGTGGCATCAGTAGTTATCATAAGTCCTTCCCGAGTGCTAGCGGAGCACTTTGATAGACATACGCCCGATAATATGGGGAGGAAGTTGAAGAAGCGTCCACCTGATGTTTTGAGGGAGGACCGGTAAGTTAGTTGTGAACGAAGATTGTAGCCTGAGATTGTTTTTTCTTTAAGTTAAAGAATTTTATGCAACGTTTGTGTCTAGCTATCCATACTCATTGTTCTCGTACGAATTCGTCTGCGGGGCAATGGAGATCAACTTTACACTATATATTTCGTGTTCCCCCACAACGTTGCACACTGGGGGCGGTGACGCCGCTGGTTGATCGTGTCCGAACTCCTTGGGGTATTGGCCCCAATATGAGGGGGATATGAGTACCTAACGTTAATTGAGGATGGTGTGGGCGTTAATTCCGTTACGAAATGCATAGCGCTAGAGGCTGCCTTGCCTTAATAGGCGATATAGCGCCTTGGAATTCGACTCATATAGTCTTGAGAGCACAATACAGGAAGCGACAGTTTGGTCATGTAGGTTATTCCATCTAGTTTGGTCATGGGGAGCCCCGGAACTGAGGAAGTCAAATTCGGAAGTCTGGGGAATTGTTCACACCAGCCATAGCCTCGGAAGATAAAATACACTTATCTAAACTACTCCGACAGCCTAATTCTCACGGACTTGTTCTAGAAACAGAGTGAGTATGACATACTCCTCGTAGGATAACCATTCCAAGGCGCCGCTTAATCTTTGGTTAAGAAAGTGCCGTTTCACTAAGGGGGGGACTTCGACACGTCTCACATACTGTCGTGGTTCGACGCACGGACAGTGGAAATTCATATGTCGTGGGCGATAGACTTGATCCTGACGCATGATCCTCCAGGCAGTGCAACTGTTGACAAATCGGCAATGTGGGGGGATGACCAGGGGCTACCCAGTCACATGTTGTTATGGTCAGACTATTGGTCAACAACTTTTGCTCCGTGGAGGCGCGCTGTCTCAGGATCCATAGGACTTTTCCCCCAAAACGTGGACGAGAGCTTAGTTCGACCGGGGGCACCCCGCACTTTAAAGCGAGTTTATGTGTTGTGGTTGTATGCACGTGATCTAGTGCGTTGGCTCACAATTGGCCTGCCGCCTGTAGTTAGAACTACTAGCTTAACCTCAGCCAGACTAGCAAATATTGGACCTCTGGCAACTCATAGCCTCAGGTTACACATCAGGTGAATTGGCAAGTAGAGTTTAAACCCCCTGATTTCAACTACGCGAGTCGGAGTCGCACGCGGCTCCTCTTTCGGCTCGTACCTCCAGACCGCCTTCATCATAACGAACCTCCGCCCAAGACGTGCTTTCATTCTATCGAGCTACCCTCATAATCCTTCGCTTCGTCGACGGTGTTGCATATAAGAGGTGGGATAACGATTTTGCGCTGCAGCCGCACGCTTAACTTGACCATGAACCCTGGAAGGTCCGGCGTTATTGTCTGCGCTGGCATCGTGCACCTCCGCGGCGCGCATTCCTTTTTTCTGGTTTATCCGGTTTAGTGTCCTAATGACTGGCAAGTCCCTTTCAATTCCAAGATACCGGGACAAGACGTTCGCACCTGGTTGCGGACATGACGCGATTGACAATCTTATGAGATACAGTAGCTAGTGATTTGCAGATAACCTAACAGGTCGAGTTACTAGTATATTTTTAGTAACTGAATAATAACAGATATGAACTTGCTCATTGGTGCTATTGTATGACATTTCTTGTGGAGCATATGCTCGCAATATGTCATTACTTAGTACCCCGTCACGGTGACTCAGCTTGTTTATCGCATCCGGATCACATACTCGTTGCGGGGAACGTTACGGCGTGCACTATTAAAACTTGTCTGCTTTGAGTAAGCTTGAAGTTAGCTTGCTACTCCGAGGAACAAGCTTGGATCTACACGTTTCCTGCGGGAGTTATCTTAGAAAGGATCGGCATTGGCTGTGCGGCTGCATACGCAGGGGTCTGTGAGACTAAATTTAGAACGCCCTGATAACTATCAGAAATCTTACTTAGTAGATACACCTAACGTACCGATAAATAAGTTCGCGCTATTTCCGCGTCAGCCCAGTATTGAGGAATACCATCTGTTTTACCAAATGCTTGATACACTTTCCTTTGCTAATTCTCCGAAGTTCGGGTGCGCGTAGTGGATCGTACGTGAGATAGGCAGTTTACGTTATCAATTGACACGGACAAAGTTATTAGTTAACACGGCGACACCATAACACCCGGAA
EOF
      end
    end
  end

  it 'should work at wandering and fixing multiple genomes' do
    fail
  end

  it 'should deal with insufficient overhang space' do
    fail
  end
end
